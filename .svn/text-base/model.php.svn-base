<?
class Model extends ActiveRecord {
/*	protected  $fields = array(
								"id" => "integer(11) not_null primary_key auto_increment",
								"nombre" => "string(255) not_null default=''",
								"idtipo" => "integer",
								"texto" => "text",
								"vendido" => "enum('si','no')",
								"visto" => "bool");
	public $grid_columns = "id, nombre, tipo_productos_id, marcas_id";
	public $belongs_to = array('tipo_productos', 'marcas');
	public $has_images = true;

*/
	protected $has_files = False;
	protected $has_images = False;

	public function __construct($createdFromSql = False)
	{
		parent::__construct();
		$this->createTableIfNecessary();
		if(is_numeric($createdFromSql)) {
			$this->select($createdFromSql);
		} else {
			if($createdFromSql) $this->exists = True;
		}
	}

	private function createTableIfNecessary() {
		static $table_created = False;
		if(!$table_created) {
			web::instance()->database->createTable($this->database_table, ActiveRecord::$metadata[$this->database_table]["fields"]);
			$table_created = True;
		}
	}

	public function __get($item) {
		if($this->has_files && $item == "files") {
			$primary_key = array_shift($this->getPrimaryKeys());
			$files = new helpers_files();
			return $files->select("module='".get_class($this)."' and iditem='".$this->$primary_key."'", "order:orden");
		} elseif ($this->has_images && $item == "images") {
			$primary_key = array_shift($this->getPrimaryKeys());
			$images = new helpers_images();
			return $images->select("module='".get_class($this)."' and iditem='".$this->$primary_key."'", "order:orden");
		}
		return parent::__get($item);
	}

	/*********************************************************************************************
	****	Llamadas a ajax
	**********************************************************************************************/
	public function listAjax() {
			$limit = $where = $order = "";
			if(isset($_REQUEST["limit"])) $limit = "limit: ".$_REQUEST["start"].", ".$_REQUEST["limit"];
			if(isset($_REQUEST["query"])) $where =  "nombre like '%".$_REQUEST["query"]."%'";
			if(isset($_REQUEST["sort"]))  $order = "order: ".$_REQUEST["sort"]." ".$_REQUEST["dir"];
			$count = $this->count($where);
			if ($_REQUEST["fields"]) $columns = "columns: ".$_REQUEST["fields"];
			$data =  $this->select($where, $limit, $columns, $order);

			$items = array();
			foreach($data as $item) $items[] = $item->getRowData();
			echo json_encode(array("items" => $items, "count" => $count));
	}

	public function listImagesAjax($id) {
			$this->select($id);
			$primary_key = array_shift($this->getPrimaryKeys());
			$images = new helpers_images();
			$data =  $images->select("module='".get_class($this)."' and iditem='".$this->$primary_key."'", "order:orden", "columns: id, nombre, extension, tipo");
			foreach($data as $item) {
				$item->url = $item->src("80x60", "INABOX");
			}

			$count = count($data);
			$items = array();
			foreach($data as $item) $items[] = $item->getRowData();

			echo json_encode(array("items" => $items, "count" => $count));
	}

	public function loadAjax($id = null) {
		$item = $this->select($id);
		$arr = array();
		foreach($this->getFields() as $field => $attr) {
			$arr[$field] = $this->$field;
		}
#		var_dump($arr);
//		echo  '{ data: '.json_encode($arr).', success: true, "recordCount" : 1}';
//		echo  json_encode(array('success' => 'true',"data" => $arr));
		header('Content-type: text/xml;');
		echo '<?xml version="1.0" encoding="UTF-8"?><response success="true"><data>';
		foreach($this->getFields() as $field => $attr) {
			if($attr["type"] == 'text')
				echo "<$field><![CDATA[".$item->$field."]]></$field>";
		}

		echo '</data></response>';

		exit;
	}


	public function saveImagesAjax($id) {
		$this->select($id);
		if($this->uploadImage()) {
			echo "{ success: true }";
		} else {
			echo "{ success : false }";
		}
		exit;
	}


	protected function upload($field, $type = 'file') {
		$file = $field ? $_FILES[$field] : $_FILES['file'];
		if(is_uploaded_file($file['tmp_name'])) {
			$primary_key = array_shift($this->getPrimaryKeys());
			$p = pathinfo($file["name"]); $extension = strtolower($p["extension"]);
			$items = $type == 'image' ? new helpers_images() : new helpers_files();
			$orden = $items->count("module='".get_class($this)."' and iditem='".$this->$primary_key."'");
			$item = $type == 'image' ? new helpers_images() : new helpers_files();
			$values = array(
							"iditem" => $this->id,
						//	"descripcion" => $descripcion,
							"extension" => $extension,
							"nombre" => $file["name"],
							"tipo" => $file["type"],
							"fecha" =>  date("Y-m-d H:i:s"),
							"module" => get_class($this),
							"orden" => $orden + 1
							);
			if($field) $values['field'] = $field;
			$id = $item->create($values);
			$item->saveUploadedFile($file["tmp_name"], $id, $extension);
			return true;
		}
		return false;
	}

	public function uploadFile($field = '') {
		$this->upload($field, 'file');

	}
	public function uploadImage($field = '') {
		$this->upload($field, 'image');
	}

	public function deleteImagesAjax($idimagen) {
		$image = new helpers_images();
		$image->delete($idimagen);
		echo "{ success: true }";
		exit;
	}

	public function deleteFilesAjax($idimagen) {
		$image = new helpers_files();
		$image->delete($idimagen);
		echo "{ success: true }";
		exit;
	}


	public function reorderImagesAjax($idimagen, $mode = 'up') {
		$imagen = new helpers_images();
		$imagen->select($idimagen);
		$iditem = $imagen->iditem;
		$images = new helpers_images();
		$images = $images->select("module='".get_class($this)."' and iditem='$iditem'", "order:orden");
		$pos = 1;
		$previous_image = null;
		foreach($images as $image) {
			$image->orden = $pos++;
			if(($image->id == $idimagen && $mode == "up") || (isset($previous_image) && $previous_image->id == $idimagen && $mode == "down")) {
				$previous_image->orden++;
				$image->orden--;
				$previous_image->save();
			}
			$image->save();
			$previous_image = $image;
		}
		exit;
	}


	public function deleteAjax() {
		$this->delete($_REQUEST["id"]);
	}

}
?>
