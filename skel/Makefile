#
# css/js minification/compression makefile
#

#
#   JS_TARGETS -- js files to minify/gzip
#   CSS_TARGETS -- css files to minify/gzip
#   CLEANUP -- additional files to delete during "make clean"
#
WEBDIR=htdocs
CSSDIR=$(WEBDIR)/css
JSDIR=$(WEBDIR)/js
JS_TARGETS = $(JSDIR)/all.js
CSS_TARGETS = $(CSSDIR)/all.css
CLEANUP = $(CSS_TARGETS) $(JS_TARGETS) $(JSDIR)/all.js $(CSSDIR)/all.css

#CLEANUP =

# you can use a manifest file for targets, if that's more your style:
#CSS_TARGETS = $(shell cat manifest.txt)

# you can specify that your targets are generated by rules, and should be deleted during "make clean"
#CLEANUP = $(CSS_TARGETS) $(JS_TARGETS)

# google closure compiler needs every input script prefixed with --js=, as in --js=file1.js
#concatenated.min.js: file1.js file2.js
#	java -jar ~/bin/compiler.jar $(addprefix --js=,$^) >$@

#custom-concat.css: file1.css file2.css file3.css
#	cat $^ >$@

#######################################################
# you shouldn't need to edit anything below this line #
#######################################################

.DEFAULT_GOAL := all

all: combine css js

YUI = yui-compressor
YUI_FLAGS = --type css

#CLOSURE = java -jar ~/bin/compiler.jar
CLOSURE = uglifyjs
CLOSURE_FLAGS = -nc

.PHONY: css js

%.gz: %
	gzip -9 <$< >$@

# css
# ---

CSS_MINIFIED = $(CSS_TARGETS:.css=.min.css)
CSS_GZIP = $(CSS_TARGETS:.css=.css.gz)
CSS_MIN_GZIP = $(CSS_TARGETS:.css=.min.css.gz)

minicss: $(CSS_TARGETS) $(CSS_MINIFIED) $(CSS_GZIP) $(CSS_MIN_GZIP)

%.min.css: %.css
	 $(YUI) $(YUI_FLAGS) <$< | sed 's/ and(/ and (/g' >$@

# javascript
# ----------

JS_MINIFIED = $(JS_TARGETS:.js=.min.js)
JS_GZIP = $(JS_TARGETS:.js=.js.gz)
JS_MIN_GZIP = $(JS_TARGETS:.js=.min.js.gz)

minijs: $(JS_TARGETS) $(JS_MINIFIED)

%.min.js: %.js
	$(CLOSURE) $(CLOSURE_FLAGS) $< >$@

clean:
	rm -f $(CSS_MINIFIED) $(CSS_GZIP) $(CSS_MIN_GZIP) $(JS_GZIP) $(JS_MINIFIED) $(JS_MIN_GZIP) $(CLEANUP)

combine: js css

js:
	cat $(shell ls $(JSDIR)/*.js | grep -v min.js | grep -v all.js) > $(JSDIR)/all.js
	make minijs
	git add  $(JS_MINIFIED)
	rm $(JSDIR)/all.js

css:
	cat $(shell ls $(CSSDIR)/*.css | grep -v min.css | grep -v all.css) > $(CSSDIR)/all.css
	make minicss
	git add $(CSS_MINIFIED) $(CSS_MIN_GZIP)
	rm $(CSSDIR)/all.css
